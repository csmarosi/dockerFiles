#!/bin/bash
set -e
set -x

docker images | sort
test -n "${1}"
imageWithTag=${1}
imageName=$(echo ${imageWithTag} | cut -d: -f1)
shift

mountDirs="-v ${HOME}/dockerVolumes/dothome:${HOME}"
mountDirsFile=${HOME}/dockerVolumes/${imageName}.vol
if echo ${imageName} | grep -qE 'chrom(e|ium)|^root_'; then
    mountDirs=''
fi
if [ -s ${mountDirsFile} ]; then
    mountDirs="$(cat ${mountDirsFile})"
fi
hostName=$(echo ${imageName} | sed 's/_//g')
runOptions="--hostname=${hostName} --name=${hostName} --rm -it"
groupId=$(id -g)
userId=$(id -u)

networkOptions='-P'
exposePortsFile=${HOME}/dockerVolumes/${imageName}.port
if [ -s ${exposePortsFile} ]; then
    networkOptions="$(cat ${exposePortsFile})"
fi
# Probably my preference should not be hardcoded as below,
#  but it should still work in a general environment as well
if docker network ls | grep -q internalbr ; then
    networkOptions+=" --net=internalbr"
fi

if [ -n "${1}" ] && docker ps --no-trunc | grep -qE "^${1}|${1}$" ; then
    networkOptions="--net=container:${1}"
    runOptions="$(echo ${runOptions} | sed 's!--hostname=[^ ]*!!')"
    shift
fi
runCommand="${@}"
if [ -n "${runCommand}" ]; then
    filePath=$(readlink -f "${runCommand}")
    if [ -f "${filePath}" ]; then
        dirName=$(dirname "${filePath}")
        mountDirs="${mountDirs} -v ${dirName}:/magic:ro"
        runCommand=$(basename "${filePath}")
    fi
fi

if echo "${imageName}" | grep -qE '^wine|^multimedia'; then
    runOptions+=" --device /dev/dri"
    runOptions+=" --group-add video"
    runOptions+=" --device /dev/snd"
    runOptions+=" --group-add audio"
fi

if [[ ${imageName} == *"gui" ]]; then
    XDisplay=$(echo ${mountDirs} | grep -o -- '-unix/X[0-9]*:' | tail -n1)
    if echo ${XDisplay} | grep -q '/X'; then
        DISPLAY=:$(echo ${XDisplay} | grep -o '[0-9]*')
    fi
    if [[ "${DISPLAY}" == ":0" ]]; then
        xhost local:
        mountDirs="${mountDirs} -v /tmp/.X11-unix/X0:/tmp/.X11-unix/X0:ro"
    fi
fi

if [[ ${imageName} == "dev"* ]]; then
    mountDirs="${mountDirs} -v ${HOME}/github_projects:${HOME}/github_projects"
fi

if [[ ${imageName} == "root"* ]]; then
    userId=0
    groupId=0
    runOptions="$(echo ${runOptions} | sed 's!--rm!!')"
fi

if [[ ${imageName} == "chromium"* ]]; then
    # Chrome leaks hostname: https://isc.sans.edu/diary/Google+Chrome+and+(weird)+DNS+requests/10312
    runOptions="$(echo ${runOptions} | sed 's!--hostname=[^ ]*!!')"
    #TODO: check this after chromium issue 522853 is closed
    tmpDir=$(mktemp -d --tmpdir=/dev/shm)
    mountDirs="${mountDirs} -v ${tmpDir}:/dev/shm"
    # Use only 1 CPU
    runOptions="${runOptions} --cpuset-cpus=0"
fi

if echo ${imageName} | grep -qE '^ulogme|^cfssl' ; then
    networkOptions="--net=none"
fi

if echo ${imageName} | grep -qE '^root_tor' ; then
    runOptions="${runOptions} --cap-add NET_ADMIN"
fi
if echo ${imageName} | grep -qE '^root_openvpn' ; then
    runOptions="${runOptions} --privileged"
fi


if [ ${userId} != 0 ]; then
    mountDirs="${mountDirs} -v /etc/passwd:/etc/passwd:ro"
    mountDirs="${mountDirs} -v /etc/group:/etc/group:ro"
else
    HOME=/root
    runOptions="${runOptions} -d"
fi

# support for non-interactive mode (i.e. crontab)
if [[ ! -t 1 ]] || [ ${userId} == 0 ]; then
    runOptions="$(echo ${runOptions} | sed 's!-it!!')"
fi

homeBind=$(echo ${mountDirs} | grep -o "[^ ]*:${HOME} " | cut -d: -f1)
test -n "${homeBind}" && cd ${homeBind} && timeout 3 git pull || true

exec docker run ${runOptions} -u=${userId}:${groupId} \
    -e HOME=${HOME} -e DISPLAY=${DISPLAY} -e SHELL=${SHELL} \
    -e QT_X11_NO_MITSHM=1 -e PULSE_SERVER=${PULSE_SERVER} \
    -e dockerImageName=${imageName} \
    ${networkOptions} \
    ${mountDirs} \
    ${imageWithTag} ${runCommand}

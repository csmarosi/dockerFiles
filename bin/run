#!/bin/bash
set -e
set -x

sudo docker images
test -n "${1}"
imageName=${1}
shift

#Don't know why is it needed...
xhost local:

mountDirs="-v ${HOME}/dockerVolumes/dothome:${HOME}"
mountDirsFile=${HOME}/dockerVolumes/${imageName}.vol
if [ -s ${mountDirsFile} ]; then
    mountDirs="$(cat ${mountDirsFile})"
fi
exposePorts=''
runOptions='--rm -it'
groupId=$(id -g)
userId=$(id -u)
runCommand='bash'


if [[ ${imageName} == "kde_"* ]]; then
    test -n "${1}"
    filePath=$(readlink -f "${1}")
    shift
    fileName=$(basename "${filePath}")
    dirName=$(dirname "${filePath}")
    mountDirs="${mountDirs} -v ${dirName}:/magic/"
    runCommand="$(echo ${imageName} | cut -d_ -f2) /magic/${fileName}"
fi

if [[ ${imageName} == "wine"* ]]; then
    runOptions="${runOptions} --privileged"
    groupId=$(awk -F: '/^video:/{print $3}' /etc/group)
fi

if [[ ${imageName} == *"gui" ]]; then
    mountDirs="${mountDirs} -v /tmp/.X11-unix:/tmp/.X11-unix:ro"
fi

if [[ ${imageName} == "dev"* ]]; then
    mountDirs="${mountDirs} -v ${HOME}/github_projects:${HOME}/github_projects"
fi

if [[ ${imageName} == "drraw" ]]; then
    exposePorts="${exposePorts} -p 8080:80"
    HOME=/root
    userId=0
    groupId=0
fi

if [[ ${imageName} == "chromium"* ]]; then
    runOptions="${runOptions} " #--cap-add SYS_ADMIN"
fi

if [[ ${imageName} == "playground"* ]]; then
    runOptions="-it"
fi


if [ ${userId} != 0 ]; then
    mountDirs="${mountDirs} -v /etc/passwd:/etc/passwd:ro"
    mountDirs="${mountDirs} -v /etc/group:/etc/group:ro"
fi

test -z "${1}"
sudo docker run ${runOptions} -u=${userId}:${groupId} \
    -e HOME=${HOME} -e DISPLAY=${DISPLAY} -e SHELL=${SHELL} \
    -e QT_X11_NO_MITSHM=1 \
    ${exposePorts} \
    ${mountDirs} \
    ${imageName} ${runCommand}
